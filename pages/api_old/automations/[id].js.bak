import { supabase } from '../../../lib/supabase'

export default async function handler(req, res) {
  const { id } = req.query
  if (req.method === 'PATCH') {
    const { name, trigger, actions, active } = req.body || {}
    const updates = {}
    if (name !== undefined) updates.name = name
    if (trigger !== undefined) updates.trigger = trigger
    if (actions !== undefined) updates.actions = actions
    if (active !== undefined) updates.active = active
    const { data, error } = await supabase.from('automations').update(updates).eq('id', id).select()
    if (error) return res.status(500).json({ error: error.message })
    return res.status(200).json((data||[])[0])
  }

  if (req.method === 'DELETE') {
    const { error } = await supabase.from('automations').delete().eq('id', id)
    if (error) return res.status(500).json({ error: error.message })
    return res.status(204).end()
  }

  res.setHeader('Allow', ['PATCH', 'DELETE'])
  res.status(405).end(`Method ${req.method} Not Allowed`)
}
